- var title = 'Feedback'

doctype html
html
	head
		include ../head.jade
		script(src="/javascripts/vue.js")
	body
		div(class='ui container')
			include ../header.jade
			include ../menu.jade
			div(id="feedback")
				h2= title
				p The Feedback system is your opportunity to put forward queries, complaints, ideas, or positive feedback when you do not know who to direct it to or you want to remain anonymous.
				p Feedback that is deemed by the Exec to be personally offensive to an Exec member or aggressive may be de-anonymised and the offenders name will be passed onto College staff and disciplinary proceedings may ensue as a result.
				div(class="ui vertical segment")
					h3 Send New Feedback
					form(class="ui feedback form" method="POST" action="/services/feedback/")
						div(class="field")
							label Title
							input(type="text" name="title")
						div(class="field")
							label Message
							textarea(rows="3" name="message")
						div(class="field")
							div(class="ui checkbox")
								input(type="checkbox" name="anonymous")
								label Anonymize my Feedback
						button(type="submit" class="ui submit button")
							i(class="write icon")
							| Send
						div(class="ui error message")

					script.
						$('.feedback.form').form({
							fields: {
								title: 'empty',
								message: 'empty'
							}
						});

				div(class="ui vertical segment")
					h3 Your previous feedback
					table(class="ui fixed table")
						thead
							tr
								th Title
								th Date
								th Replies
						tbody
							tr(v-for="post in feedback | orderBy 'timestamp' -1")
								td
									i(v-if="!post.read_by_user" class="ui red circle icon")
									i(v-if="post.archived" class="archive icon")
									a(v-bind:href='"/services/feedback/"+post.id') {{ post.title }}
								td {{post.timestamp | prettyDate}}
								td
									a(class="ui label" v-bind:href='"/services/feedback/"+post.id') {{ post.no_replies }}
		
		script.

			Vue.filter('prettyDate', function (time) {
				var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
				var date = new Date((time || "").replace(/-/g,"/").replace(/[TZ]/g," ")),
					diff = (((new Date()).getTime() - date.getTime()) / 1000),
					day_diff = Math.floor(diff / 86400);
						
				if ( isNaN(day_diff) || day_diff < 0)
					return;

				return day_diff == 0 && (
						diff < 60 && "just now" ||
						diff < 120 && "1 minute ago" ||
						diff < 3600 && Math.floor( diff / 60 ) + " minutes ago" ||
						diff < 7200 && "1 hour ago" ||
						diff < 86400 && Math.floor( diff / 3600 ) + " hours ago") ||
					day_diff == 1 && "Yesterday" ||
					day_diff < 7 && day_diff + " days ago" ||
					day_diff < 31 && Math.ceil( day_diff / 7 ) + " weeks ago" ||
					date.getDate() + " " + months[date.getMonth()] + " " + date.getFullYear()
			});

			var feedback = new Vue({
				el: "#feedback",
				data: {
					feedback: []
				},
				methods: {
					fetchFeedback: function() {
						var self = this;
						$.get('/api/feedback', function(response) {
							self.feedback = response.data;
						}, 'json');
					}
				},
				created: function() {
					this.fetchFeedback();
				}
			});

		include ../footer.jade