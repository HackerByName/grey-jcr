- var title = 'Profile'

doctype html
html
	head
		include ../head.jade
		script(src="/javascripts/vue.js")
	body
		div(class='ui container')
			include ../header.jade
			include ../menu.jade
			div(class="ui divided stackable vertically padded grid")
				div(class="five wide column")
					h3(class="ui dividing header")= position.title
					p= position.description
					h3(class="ui dividing header") Files
					div(class="ui directory list")

					script.
						var parent = 0;
						var current = !{position.dirid};
						function getFiles(dirId) {
							$('.directory.list').parent().addClass("loading");
							$('.directory.list').html("");
							$.get('/api/files/'+dirId, function (data) {
								$('.directory.list').parent().removeClass("loading");
								current = data.current;
								if (current.parent != 0) {
									$('.directory.list').append(
										"<a class='directory item' data-id="+current.parent+"><i class='level up icon'></i><div class='content'><div class='header'>Up a level</div></div>"
									);
								}
								for (i=0; i<data.directories.length; i++) {
									$('.directory.list').append(
										"<a class='directory item' data-id="+data.directories[i].id+"><i class='folder icon'></i><div class='content'><div class='header'>"+data.directories[i].name+"</div></div>"
									);
								}
								for (i=0; i<data.files.length; i++) {
									$('.directory.list').append(
										"<a href='/files/uploaded/"+data.files[i].path+"' class='item'><i class='file icon'></i><div class='content'><div class='header'>"+data.files[i].name+"</div>"+((data.files[i].description)?"<div class='description'>"+data.files[i].description+"</div>":"")+"</div>"
									);
								}
							});
						}
						$(document).on("click",".directory.item" ,function (e){
							e.preventDefault();
							parent = current;
							getFiles($(this).attr("data-id"));
						})
						getFiles(current);

				div(class="eleven wide column" id="blog")
					h3(class="ui header") Recent Posts
					div(class="ui divided items")
						blog-post(class="item" v-for="post in posts", :title="post.title", :slug="post.slug", :content="post.message", :timestamp="post.timestamp", :author="post.author")
					div(class="ui pagination menu")
						a(class="item" v-for="n in pages" v-bind:class="{'active': (n+1 == page)}" v-on:click.stop="setPage(n+1)") {{ n+1 }}

		script.
			Vue.component('blog-post', {
				props: ['title', 'slug', 'content', 'timestamp', 'author'],
				computed: {
					permalink: function() {
						return "/jcr/blog/"+this.author.slug+"/"+this.timestamp.getFullYear()+"/"+(this.timestamp.getMonth()+1)+"/"+this.slug
					}
				},
				template: '<div class="item"><div class="content"><a class="header" v-bind:href="permalink">{{ title }}</a><div class="meta"><span class="author"><i class="ui user icon"></i>{{ author.name }} ({{ author.title }})</span><span class="timestamp"><i class="ui clock icon"></i>{{ timestamp }}</span></div><div class="article description">{{{ content }}}</div></div></div>'
			});

			var blog = new Vue({
				el: "#blog",
				data: {
					positionSlug: '!{position.slug}',
					total: 0,
					posts: [],
					limit: 8,
					page: 1
				},
				computed:{
					pages: function() {return Math.ceil(this.total/this.limit)}
				},
				methods: {
					fetchPosts: function() {
						var self = this;
						$("#calendar").addClass('loading');
						$.get('/api/blog/'+self.positionSlug+'?page='+self.page+'&length='+self.limit, function(response) {
							self.total = response.total;
							for (i = 0; i < response.data.length; i++ ){
								response.data[i].timestamp = new Date(response.data[i].timestamp);
							}
							self.posts = response.data;
						}, 'json');
					},
					setPage: function (page) {
						this.page = page;
					}
				},
				created: function() {
					this.fetchPosts();
				},
				watch: {
					'page': 'fetchPosts',
					'limit': 'fetchPosts'
				}
			});

		include ../footer.jade